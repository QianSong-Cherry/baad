How to build a plant
=======================
Daniel Falster, Remko Duursma, Diego Barneche

```{r echo=FALSE, message=FALSE, warning=FALSE}
source("../R/fillDerivedVariables.R")
source("../R/import.R")
library(gplots)
library(scales)
library(magicaxis)

if(!file.exists("../cache/allomdata.rds")){
  dat <- loadStudies(reprocess=FALSE)
  data <- fillDerivedVariables(dat$data)
  saveRDS(data, file="cache/allomdata.rds")
} else {
  data <- readRDS("../cache/allomdata.rds")
}
data$dataset_species <- as.factor(paste(data$dataset, data$species, sep="-"))

```

Goal: Establish foundations for modelling plant growth through ontogeny, emphasising simple hypotheses, areas where important differences lie (e.g. between species, between vegetation, light env)

# Relationships to test

## An allometric relation between total leaf area and plant height

- is there linear log-log relationship between leaf area and height across size range?
- slope seems to increase in the upper range of heights, leaf area and (less distinctly) leaf mass increase more steeply relative to height gain. Or to put that the other way round, height gain slows even though canopy expansion is continuing
  - how much of this is higher SLA in the taller plants?
  - how much of it is a between species rather than a within-species effect?
  - it should be apparent also in the relation between stem or sapwood cross

- how much variation between species within sites; species across sites; vegetation types; light env within sites?

## The pipe model, relating cross-sectional area of sapwood and bark to total leaf area.

- is there linear log-log relationship across size range between sapwood cross section and total leaf area?
  - for smaller stems: use total area

- expect slope different to 1 for total stem cross section, because incorporates heartwood
  - better with stem area at crown base (as per Makela hypothesis)

- is there linear log-log relationship across size range between bark cross section and total leaf area?
  - for smaller stems: use total area

- how much variation between species within sites; species across sites; vegetation types; light env within sites?

## Ratio of root mass to leaf area.

- is there linear log-log relationship across size range between root mass and total leaf area?

```{r echo=FALSE}
dfr <- subset(data, !is.na(m.rf) & !is.na(m.lf) & pft != "")
dfr$pft <- as.factor(dfr$pft)

sm <- lapply(split(dfr, dfr$pft), function(x){
      sma(log10(m.rf) ~ log10(m.lf)*dataset_species, 
           data=x)
      })

  
palette(alpha(rich.colors(4),0.5))
with(dfr, plot(log10(m.lf), log10(m.rf), 
               axes=FALSE,
               xlab="Aboveground biomass (kg)",
               ylab="Foliage mass (kg)",
               type='n',col=pft, panel.first={
                 for(z in c(0.05, 0.25, 0.5, 0.75, 1))abline(log10(z),1)
               }))
magaxis(side=c(1,2), unlog='xy', tcl=-0.4)
for(i in 1:3)plot(sm[[i]], add=TRUE, col=palette()[i], type='l', lwd=2)
box()
legend("bottomright", levels(dfr$pft), fill=alpha(palette(),1))



```
Figure X. Lines are with exponent of 1, and represent fixed ratios between fine root biomass and leaf biomass (from top to bottom: 1, 0.75, 0.5, 0.25, 0.05).


- how much variation between species within sites; species across sites; vegetation types; light env within sites?



## Leaf mass fraction

```{r echo=FALSE, eval=FALSE}
# subset/refine data.
dfr <- droplevels(subset(data, !is.na(m.st) & !is.na(m.lf) & pft != "" & m.lf > 0))
dfr <- within(dfr, {
  dataset <- as.factor(dataset)
  species <- as.factor(species)
  pft <- as.factor(pft)
  m.lf.fraction <- with(dfr, m.lf / m.so)
  log_m.so <- log10(m.so)
  log_m.lf.fraction <- log10(m.lf.fraction)
})

with(dfr, plot(log_m.so, log_m.lf.fraction, axes=FALSE,
               xlab="Aboveground biomass (kg)",
               ylab="Leaf mass fraction (-)",
               pch=19, col=pft
))
magaxis(side=c(1,2), unlog='xy', tcl=-0.4)
box()
legend("topright", levels(dfr$pft), pch=19, col=palette())
#Figure X. Much higher leaf mass fraction for evergreen gymnosperms at a given total aboveground plant biomass.
```


```{r echo=FALSE, eval=FALSE}
dfr <- droplevels(subset(data, !is.na(m.st) & !is.na(m.lf) & !is.na(m.rt) & 
                           m.lf > 0 & m.rt > 0 & pft != "" & 
                           m.st < m.to))
dfr$m.to <- with(dfr, m.rt + m.st + m.lf)

dfr$dataset <- as.factor(dfr$dataset)
dfr$species <- as.factor(dfr$species)
dfr$pft <- as.factor(dfr$pft)
dfr$m.lf.fraction <- with(dfr, m.lf / m.to)
dfr$m.st.fraction <- with(dfr, m.st / m.to)
dfr$m.rt.fraction <- with(dfr, m.rt / m.to)


par(mfrow=c(2,2))
plotit <- function(Pft, dataset){
  x <- subset(dataset, pft == Pft)
  with(x, plot(log10(m.to), m.rt.fraction, col="red", ylim=c(0,1.1),
               xlab="Total biomass (kg)",
               ylab="Biomass fractions (-)",
               main=Pft,
               axes=FALSE))

  magaxis(side=1, unlog='x', tcl=-0.4)
  axis(2, at=seq(0,1,by=0.2))
  box()
  with(x, points(log10(m.to), m.rt.fraction + m.lf.fraction, col="blue"))
  abline(h=1, lwd=2, col="forestgreen")
}
for(z in c("DA","EA","EG"))plotit(z,dfr)


plot(1, type='n', ann=FALSE, axes=FALSE)
legend("left", c("Root","Root+Leaf","Root+Leaf+Stem"), pch=c(19,19,-1),
                 lty=c(-1,-1,1), col=c("red","blue","forestgreen"), cex=0.8)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

 
dfr <- droplevels(subset(data, !is.na(m.so) & !is.na(m.lf) & pft != "" &
                           m.lf > 0 & m.so > 0))
dfr$pft <- as.factor(dfr$pft)
                           

sm <- lapply(split(dfr, dfr$pft), function(x){
      sma(log10(m.lf) ~ log10(m.so)*dataset_species, 
           data=x)
      })

  
palette(alpha(rich.colors(4), 0.4))
with(dfr, plot(log10(m.so), log10(m.lf), 
               axes=FALSE,
               xlab="Aboveground biomass (kg)",
               ylab="Foliage mass (kg)",
               type='n',col=pft, panel.first={
                 for(z in c(-2,-1,0))abline(z,1)
                 
               }))
magaxis(side=c(1,2), unlog='xy', tcl=-0.4)
for(i in 1:4)plot(sm[[i]], add=TRUE, col=palette()[i], type='l')
box()
legend("bottomright", levels(dfr$pft), fill=alpha(palette(),1))


```


## Equations for total biomass

- stem biomass predicted from height & traits via simple equation:
- leaf biomass?

