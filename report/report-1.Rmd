```{r, echo=FALSE}

locLevelInfo  <-  function(data){
  
  vars <- c("location","longitude","latitude","vegetation")
  
  loc <- data[!duplicated(data[,vars]),vars]
  
  loc[is.na(loc) | loc=="" | loc=="NA"]  <-  "missing"  
  return(loc)
}


standLevelInfo  <-  function(data){
  
  vars <- c("location","grouping","growingCondition","status")
  sta <- data[!duplicated(data[,vars]),vars]
    
  if(all(is.na(sta$grouping)))
    sta  <-  sta[,-which(names(sta) == "grouping")]
  
  sta[is.na(sta) | sta=="" | sta=="NA"]  <-  "missing"  
  
  return(sta)
}


spLevelInfo  <-  function(data){
  spec         <-  data.frame(species=as.character(unique(data$species)), stringsAsFactors=FALSE)
  for(z in c("family", "pft")){
    spec[[z]]  <-  as.character(data[[z]][match(spec$species,data$species)])
    i          <-  spec[[z]]=="" | is.na(spec[[z]]) 
    if(any(i)){
      spec[[z]][i]  <-  "missing"
    }
  }
  j            <-  spec$species=="" | is.na(spec$species) 
  if(any(j)){
    spec$species[j]  <-  "missing"
  }
  spec
}

printMeta  <-  function(data){
  dataset   <-  as.character(unique(data$dataset))
  openMeta  <-  read.csv(paste0("../",dir.rawData,"/",dataset,"/studyMetadata.csv"), h=TRUE, stringsAsFactors=FALSE)
  openMeta
}


```

# Report for study: `r .study`

## Contact Information

**Data contributor:** `r .dat$contact$name`.

**Email:** `r .dat$contact$email`.

**Address:** `r .dat$contact$address`.

## Citation
Information about the primary reference for the data you provided. 
```{r echo=FALSE, comment=''}
  bibfile<- paste0("../", as.character(.dat$ref$filename))
```
**Reference:** `r formatBib(bibfile)[[1]]`

**DOI:** `r  bibGetElement(bibfile, element = "doi")`

**Abstract:** `r  bibGetElement(bibfile, element = "abstract")`

## Overview of data provided

Data for `r length(.dat$data$dataset)` individuals from `r length(unique(.dat$data$location))` locations covering `r length(unique(.dat$data$species))` species.

The dataset includes `r length(unique(.dat$data$species))` species belonging to `r length(unique(.dat$data$family))` family(ies), presenting `r length(unique(.dat$data$pft))` functional type(s), growing in `r length(unique(.dat$data$growingCondition))` condition(s) within `r length(unique(.dat$data$vegetation))` major type(s) of habitat:


### Number of records for each variable

```{r echo=FALSE, comment=''}
counts  <-  apply(!is.na(.dat$data), MARGIN=2, FUN = sum)
counts  <-  counts[counts>0]  #only include no zeros
counts  <-  counts[names(counts)%in%var.def$Variable[var.def$Group=="tree"]]
cbind(counts)
```


## Study details

### Location

**Location data**
```{r echo=FALSE, message=FALSE, warning=FALSE, comment=''}
options(width =160)
locLevelInfo(.dat$data)
```

**Global map**

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}
prepdata  <-  prepMapInfo(alldata$data, .study)
drawWorldPlot (prepdata)
```

**Country map**

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}
repMissingInfo(prepdata)
drawCountryPlot(prepdata)
```

**Stand description**
Information about the growing condition of plants in your study, i.e. their local environment.

```{r echo=FALSE, message=FALSE, warning=FALSE, comment=''}
standLevelInfo(.dat$data)
```

### Species data

```{r echo=FALSE, message=FALSE, warning=FALSE, comment=''}
spLevelInfo(.dat$data)
```

### Methods
```{r echo=FALSE, message=FALSE, warning=FALSE, comment=''}
metaTable  <-  printMeta(.dat$data)
for(j in 1:nrow(metaTable)){
  cat(paste0(metaTable[j,1], ": ", metaTable[j,2], "\n\n"))
}

```

## Plots of data

This is how the study `r .study` (each colour represents a species) fits in the entire dataset (grey).

```{r fig.height=8, fig.width=8, echo=FALSE, warning=FALSE, message=FALSE}
makePlotPanel(alldata$data, .study, pdf=FALSE, quiet=TRUE)
```


  
  
  